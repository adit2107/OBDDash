<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?key=AjkXX1zT7YHy-_LtxMnidsm-asX1f__I79nFe4BBo2ELOe233gyXIRQnNDK9I1_I&callback=loadMapScenario' async defer></script> -->
	<script type='text/javascript' src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfUUHNbHPPG0Lx7k3nqBV-P-hmZ70k1AQ&callback=initMap" async defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
	<link rel="stylesheet" href="https://bootswatch.com/3/paper/bootstrap.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.all.js"></script>
  <script type="text/javascript" src="http://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.js"></script>
	<script type="text/javascript">
	const dataSource = {
  "chart": {
    "lowerlimit": "20",
    "upperlimit": "100",
    "numbersuffix": "Â°C",
    "thmfillcolor": "#008ee4",
    "showgaugeborder": "1",
    "gaugebordercolor": "#008ee4",
    "gaugeborderthickness": "2",
    "plottooltext": "Temperature: <b>$datavalue</b> ",
    "theme": "fusion",
    "showvalue": "1"
  },
	"value": "20",
	"annotations": {
          "showbelow": "0",
          "groups": [{
            //Each group needs a unique ID
            "id": "indicator",
            "items": [
              //Showing Annotation
              {
                "id": "background",
                //Rectangle item 
                "type": "rectangle",
                "alpha": "50",
                "fillColor": "#AABBCC",
                "x": "$gaugeEndX-40",
                "tox": "$gaugeEndX",
                "y": "$gaugeEndY+54",
                "toy": "$gaugeEndY+72"
              }
            ]
          }]

        }
};
	</script>
  <style>
  .grid-stack > .grid-stack-item > .grid-stack-item-content{
    overflow-y: hidden;
  }

	#bingmap{
		height: 100%;
		width: 100%;
	}
  </style>
</head>
<body>
  <div class="container">
  		<div class="row">
  			<div class="col-sm-12 text-center">
  				<h2>OBD Live Dashboard</h2>
  			</div>
  			<div class="col-sm-12 well">
  				<div class="grid-stack" staticGrid="true">
  					<div class="grid-stack-item" data-gs-x="8" data-gs-y="0" data-gs-width="4" data-gs-height="4">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Engine Load</h3>
  							</div>
  							<div class="panel-body">
  							</div>
  						</div>
  					</div>
  					<div class="grid-stack-item" data-gs-x="0" data-gs-y="0" data-gs-width="8" data-gs-height="4">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Car Statistics</h3>
  							</div>
  							<div class="panel-body">
  							</div>
  						</div>
  					</div>
  					<div class="grid-stack-item" data-gs-x="3" data-gs-y="4" data-gs-width="3" data-gs-height="2">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Coolant Temperature</h3>
  							</div>
  							<div id="chart-container">
  							</div>
  						</div>
  					</div>
            <div class="grid-stack-item" data-gs-x="3" data-gs-y="6" data-gs-width="3" data-gs-height="2">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Throttle Position</h3>
  							</div>
  							<div class="panel-body">
  							</div>
  						</div>
  					</div>
            <div class="grid-stack-item" data-gs-x="0" data-gs-y="4" data-gs-width="3" data-gs-height="2">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Panel</h3>
  							</div>
  							<div id="rpmdiv" class="panel-body">
  							</div>
  						</div>
  					</div>
            <div class="grid-stack-item" data-gs-x="0" data-gs-y="6" data-gs-width="3" data-gs-height="2">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">Panel</h3>
  							</div>
  							<div id="speeddiv" class="panel-body">
  							</div>
  						</div>
  					</div>
            <div class="grid-stack-item" data-gs-x="6" data-gs-y="4" data-gs-width="6" data-gs-height="4">
  						<div class="grid-stack-item-content panel panel-primary">
  							<div class="panel-heading text-center">
  								<h3 class="panel-title">GPS Co-ordinates</h3>
  							</div>
                  <div id="bingmap">
  					</div>
  				</div>
  			</div>
  		</div>
  	</div>
  </div>
</div>
</body>
<script type="text/javascript">
var socket = io.connect('http://localhost:3001');
socket.on('speed', function(data){
  //alert(data["speed"]);
});
socket.on('coolant', function(data){
	 //alert(data["coolant"]);
	 //dataSource["value"] == data["coolant"];
	//  FusionCharts.ready(function() {
	// 	 var updateAnnotation;
  //  var myChart = new FusionCharts({
	// 		type: "thermometer",
  //     renderAt: "chart-container",
  //     width: "213px",
  //     height: "110px",
  //     dataFormat: "json",
	// 		dataSource,
	// 		"events": {
  //       "initialized": function(evt, arg) {
  //         var dataUpdate = setInterval(function() {
  //           var value,
  //             prevTemp = FusionCharts.items["myThm"].getData()

  //           FusionCharts.items["myThm"].feedData("&value=" + value);

  //         }, 3000);
  //         updateAnnotation = function(evtObj, argObj) {
  //           var code,
  //             chartObj = evtObj.sender,
  //             val = chartObj.getData(),
  //             annotations = chartObj.annotations;

  //           if (val >= 30) {
  //             code = "#00FF00";
  //           } else if (val < 30 && val > 40) {
  //             code = "#ff9900";
  //           } else {
  //             code = "#ff0000";
  //           }
  //           annotations.update("background", {
  //             "fillColor": code
  //           });
  //         };
  //       },
  //       "renderComplete": function(evt, arg) {
  //         updateAnnotation(evt, arg);
  //       },
  //       "realtimeUpdateComplete": function(evt, arg) {
  //         updateAnnotation(evt, arg);
  //       }
  //     }
  //  }).render();
// });
});
socket.on('rpm', function(data){
  // alert(data["rpm"]);
});
socket.on('engine', function(data){
  // alert(data["engine"]);
});
socket.on('tp', function(data){
  // alert(data["tp"]);
});
socket.on('coord', function(data){
	//alert(data.x, data.y);
	//loadMapScenario(data.x, data.y);
	//initMap(data);
	SetMarker(data);
	
});

var options = {
  staticGrid: true
}
$(function () {
    $('.grid-stack').gridstack(options);
});
window.onload = function(){
	initMap();
};
var map;
var marker;

function initMap(data) {
	if (marker != null) {
             marker.setMap(null);
         }
        var mapOptions = {
					center: new google.maps.LatLng(data.x, data.y),
            zoom: 5,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('bingmap'), mapOptions);
				bounds  = new google.maps.LatLngBounds();  
 
        //Set Marker on Map.
				var myLatlng = new google.maps.LatLng(data.x, data.y);
				//var myLatlng = {lat: data.x, lng: data.y};
        marker = new google.maps.Marker({
						position: myLatlng,
						map: map
				});
				console.log('Pos changed' + data.x + "," + data.y);
				marker.setPosition(myLatlng);
				bounds.extend(myLatlng);
				map.fitBounds(bounds);
				map.panToBounds(bounds);  
				map.setZoom(10);
				console.log('Getting position of marker:' + marker.getPosition());	
				//marker.setMap(null);
		};

// function SetMarker(data) {
// 	bounds  = new google.maps.LatLngBounds();
//         //Remove previous Marker.
//         if (marker != null) {
//             marker.setMap(null);
//         }
 
//         //Set Marker on Map.
// 				var myLatlng = new google.maps.LatLng(data.x, data.y);
// 				//var myLatlng = {lat: data.x, lng: data.y};
//         marker = new google.maps.Marker({
// 						position: myLatlng,
// 						map: map
// 				});
// 				console.log('Pos changed' + data.x + "," + data.y);
// 				console.log('Getting latlng: ' + myLatlng);
// 				marker.setPosition(myLatlng);
// 				bounds.extend(myLatlng);
// 				map.fitBounds(bounds);
// 				map.panToBounds(bounds);  
// 				map.setZoom(10);
// 				console.log('Getting position of marker:' + marker.getPosition());
				
//     };


</script>
</html>